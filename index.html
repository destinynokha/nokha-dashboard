<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üìä NOKHA TYRES - Debtors Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8f9fa;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: linear-gradient(135deg, #0b5394, #1a73e8);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            margin-bottom: 30px;
            box-shadow: 0 4px 20px rgba(11, 83, 148, 0.3);
        }

        .header h1 {
            font-size: 2.2em;
            font-weight: 700;
            margin-bottom: 5px;
        }

        /* Navigation Tabs */
        .nav-tabs {
            display: flex;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            overflow: hidden;
        }

        .nav-tab {
            flex: 1;
            padding: 15px 20px;
            background: #f8f9fa;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            border-right: 1px solid #e1e5e9;
        }

        .nav-tab:last-child {
            border-right: none;
        }

        .nav-tab.active {
            background: #1a73e8;
            color: white;
        }

        .nav-tab:hover:not(.active) {
            background: #e8f0fe;
        }

        /* Page Content */
        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        .controls {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            align-items: end;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
        }

        .form-group input, .form-group select, .form-group textarea {
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 14px;
            background: #fff2cc;
            transition: all 0.3s ease;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 60px;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #1a73e8;
            box-shadow: 0 0 0 3px rgba(26, 115, 232, 0.1);
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: #1a73e8;
            color: white;
        }

        .btn-primary:hover {
            background: #1557b0;
            transform: translateY(-2px);
        }

        .btn-success {
            background: #34a853;
            color: white;
        }

        .btn-success:hover {
            background: #2d9142;
        }

        .btn-warning {
            background: #fbbc04;
            color: #333;
        }

        .btn-warning:hover {
            background: #ea8600;
            color: white;
        }

        .totals {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .total-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }

        .total-card.overdue {
            border-left: 5px solid #ea4335;
        }

        .total-card.regular {
            border-left: 5px solid #34a853;
        }

        .total-card.grand {
            border-left: 5px solid #1a73e8;
            background: #c9daf8;
        }

        .total-card h3 {
            color: #666;
            font-size: 0.9em;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .total-card .amount {
            font-size: 1.8em;
            font-weight: 700;
            color: #333;
        }

        .data-table {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .table-header {
            background: #d9ead3;
            padding: 15px 20px;
            font-weight: 600;
            border-bottom: 2px solid #e8f5e8;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .table-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .table-container {
            max-height: 600px;
            overflow-y: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        th {
            background: #d9ead3;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .overdue-row {
            background: #f4cccc !important;
        }

        .overdue-row:hover {
            background: #f0b8b8 !important;
        }

        .checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .remarks-input {
            width: 100%;
            min-width: 150px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .error {
            background: #fce8e6;
            color: #d93025;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border: 1px solid #f5c6cb;
        }

        .success {
            background: #e8f5e9;
            color: #137333;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border: 1px solid #c3e6cb;
        }

        .config-section {
            background: #fff;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .config-section h3 {
            color: #1a73e8;
            margin-bottom: 15px;
        }

        .sort-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .sort-btn {
            padding: 8px 16px;
            border: 1px solid #ddd;
            background: white;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.3s ease;
        }

        .sort-btn.active {
            background: #1a73e8;
            color: white;
            border-color: #1a73e8;
        }

        .sort-btn:hover:not(.active) {
            background: #f1f3f4;
        }

        .remarks-section {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }

        .remark-item {
            background: white;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 8px;
            border-left: 4px solid #1a73e8;
        }

        .remark-meta {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }

        .remark-text {
            font-size: 14px;
            line-height: 1.4;
        }

        @media (max-width: 768px) {
            .controls-grid {
                grid-template-columns: 1fr;
            }
            
            .totals {
                grid-template-columns: 1fr;
            }
            
            .nav-tabs {
                flex-direction: column;
            }
            
            table {
                font-size: 14px;
            }
            
            th, td {
                padding: 8px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä NOKHA TYRES Debtors Dashboard</h1>
            <p>Comprehensive debt management and tracking system</p>
        </div>

        <!-- Navigation Tabs -->
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showPage('dashboard')">üìä Main Dashboard</button>
            <button class="nav-tab" onclick="showPage('summary')">üë• Debtor Summary</button>
            <button class="nav-tab" onclick="showPage('findings')">üìù Findings & Remarks</button>
        </div>

        <!-- Page 1: Main Dashboard -->
        <div id="dashboard" class="page active">
            <div class="controls">
                <div class="controls-grid">
                    <div class="form-group">
                        <label for="fromDate">From Date:</label>
                        <input type="date" id="fromDate">
                    </div>
                    
                    <div class="form-group">
                        <label for="toDate">To Date:</label>
                        <input type="date" id="toDate">
                    </div>
                    
                    <div class="form-group">
                        <label for="customer">Select Customer:</label>
                        <select id="customer">
                            <option value="">All Customers</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="dueDays">Due Days:</label>
                        <input type="number" id="dueDays" value="7" min="0">
                    </div>
                    
                    <div class="form-group">
                        <button class="btn btn-primary" onclick="refreshDashboard()">
                            üìä Refresh Dashboard
                        </button>
                    </div>
                </div>
            </div>

            <div class="totals" id="totals">
                <div class="total-card grand">
                    <h3>Total Debtors</h3>
                    <div class="amount" id="totalDebtors">‚Çπ0.00</div>
                </div>
                <div class="total-card overdue">
                    <h3>Overdue Total</h3>
                    <div class="amount" id="overdueTotal">‚Çπ0.00</div>
                </div>
                <div class="total-card regular">
                    <h3>Regular Total</h3>
                    <div class="amount" id="regularTotal">‚Çπ0.00</div>
                </div>
                <div class="total-card grand">
                    <h3>Grand Total</h3>
                    <div class="amount" id="grandTotal">‚Çπ0.00</div>
                </div>
            </div>

            <div class="data-table">
                <div class="table-header">
                    <span>üìã Debtors Data</span>
                    <div class="table-controls">
                        <button class="btn btn-success" onclick="copySelectedToFindings()">
                            üì§ Copy Selected to Findings
                        </button>
                    </div>
                </div>
                <div class="table-container">
                    <table>
                        <thead id="tableHeader">
                            <tr>
                                <th>Select</th>
                                <th>Customer Code</th>
                                <th>Customer Name</th>
                                <th>Type</th>
                                <th>Doc. No.</th>
                                <th>Posting Date</th>
                                <th>Due Date</th>
                                <th>Balance Due</th>
                                <th>Staff Remarks</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody">
                            <tr>
                                <td colspan="9" class="loading">
                                    üîÑ Click "Refresh Dashboard" to load data
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Page 2: Debtor Summary -->
        <div id="summary" class="page">
            <div class="controls">
                <h3>üë• Customer-wise Outstanding Summary</h3>
                <div class="sort-controls">
                    <button class="sort-btn active" onclick="sortSummary('amount')">Sort by Amount (High to Low)</button>
                    <button class="sort-btn" onclick="sortSummary('name')">Sort by Name (A to Z)</button>
                    <button class="btn btn-primary" onclick="refreshSummary()">üîÑ Refresh Summary</button>
                </div>
            </div>

            <div class="data-table">
                <div class="table-header">
                    <span>üìà Customer Summary</span>
                    <span id="summaryCount">0 customers</span>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>S.No.</th>
                                <th>Customer Name</th>
                                <th>Total Outstanding</th>
                                <th>% of Total</th>
                            </tr>
                        </thead>
                        <tbody id="summaryTableBody">
                            <tr>
                                <td colspan="4" class="loading">
                                    üîÑ Click "Refresh Summary" to load data
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Page 3: Findings & Remarks -->
        <div id="findings" class="page">
            <div class="controls">
                <h3>üìù Findings & Remarks Management</h3>
                <div class="controls-grid">
                    <div class="form-group">
                        <button class="btn btn-primary" onclick="refreshFindings()">üîÑ Refresh Findings</button>
                    </div>
                    <div class="form-group">
                        <button class="btn btn-warning" onclick="updateAllRemarks()">üíæ Save All Remarks</button>
                    </div>
                    <div class="form-group">
                        <button class="btn" onclick="debugFindings()" style="background: #9aa0a6; color: white;">üîç Debug Findings</button>
                    </div>
                </div>
                <p style="color: #666; margin-top: 10px; font-size: 14px;">
                    ‚úèÔ∏è Both staff and management can edit their remarks. Click "Save All Remarks" to update the Google Sheet.
                </p>
            </div>

            <div class="data-table">
                <div class="table-header">
                    <span>üìã Findings with Staff & Management Remarks</span>
                    <span id="findingsCount">0 findings</span>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Customer Code</th>
                                <th>Customer Name</th>
                                <th>Doc. No.</th>
                                <th>Balance Due</th>
                                <th>Staff Remarks</th>
                                <th>Management Remarks</th>
                                <th>Date Added</th>
                            </tr>
                        </thead>
                        <tbody id="findingsTableBody">
                            <tr>
                                <td colspan="7" class="loading">
                                    üîÑ Click "Refresh Findings" to load data
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration - Replace this URL with your actual Google Apps Script deployment URL
        const API_URL = 'https://script.google.com/macros/s/AKfycbz5XLwZEGT0q3_YUw8uoladqGmh5H9Nfzq4RMFHU591nDBmR51lkYTNdlbIdV_cqLQ/exec';
        
        let currentData = [];
        let selectedRows = new Set();
        let summaryData = [];
        let currentSortBy = 'amount';

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Set default dates
            const today = new Date();
            const toDateInput = document.getElementById('toDate');
            toDateInput.value = today.toISOString().split('T')[0];
            
            // Load customers automatically after a delay
            setTimeout(loadCustomers, 1000);
        });

        function showPage(pageId) {
            // Hide all pages
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            
            // Remove active from all tabs
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected page
            document.getElementById(pageId).classList.add('active');
            
            // Mark active tab
            event.target.classList.add('active');
        }

        async function makeRequest(action, params = {}) {
            if (!API_URL || API_URL === 'YOUR_GOOGLE_APPS_SCRIPT_URL_HERE') {
                throw new Error('Please configure the API_URL in the script. Contact your administrator.');
            }

            console.log(`Making request: ${action}`, params);

            const formData = new FormData();
            formData.append('action', action);
            
            Object.keys(params).forEach(key => {
                formData.append(key, params[key]);
            });

            const response = await fetch(API_URL, {
                method: 'POST',
                body: formData,
                redirect: 'follow'
            });

            console.log('Response status:', response.status);

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const textResponse = await response.text();
            console.log('Raw response:', textResponse);

            let result;
            try {
                result = JSON.parse(textResponse);
            } catch (e) {
                console.error('Failed to parse JSON:', textResponse);
                throw new Error('Invalid JSON response from server');
            }
            
            if (result.error) {
                throw new Error(result.error);
            }

            console.log('Parsed result:', result);
            return result;
        }

        async function loadCustomers() {
            try {
                console.log('Loading customers...');
                const customers = await makeRequest('getCustomers');
                console.log('Received customers:', customers);
                
                const customerSelect = document.getElementById('customer');
                
                // Clear existing options except "All Customers"
                customerSelect.innerHTML = '<option value="">All Customers</option>';
                
                if (Array.isArray(customers) && customers.length > 0) {
                    customers.forEach(customer => {
                        if (customer && customer.trim() !== '') {
                            const option = document.createElement('option');
                            option.value = customer;
                            option.textContent = customer;
                            customerSelect.appendChild(option);
                        }
                    });
                    console.log(`Added ${customers.length} customers to dropdown`);
                    showSuccess(`Loaded ${customers.length} customers successfully!`);
                } else {
                    console.warn('No customers found or invalid response:', customers);
                    const option = document.createElement('option');
                    option.value = '';
                    option.textContent = 'No customers found';
                    customerSelect.appendChild(option);
                }
            } catch (error) {
                console.error('Error loading customers:', error);
                showError('Failed to load customers: ' + error.message);
                
                // Add debug option
                const customerSelect = document.getElementById('customer');
                const debugOption = document.createElement('option');
                debugOption.value = '';
                debugOption.textContent = 'Error: ' + error.message;
                customerSelect.appendChild(debugOption);
            }
        }

        async function refreshDashboard() {
            const tableBody = document.getElementById('tableBody');
            tableBody.innerHTML = '<tr><td colspan="9" class="loading">üîÑ Loading data...</td></tr>';

            try {
                const params = {
                    fromDate: document.getElementById('fromDate').value,
                    toDate: document.getElementById('toDate').value,
                    customerName: document.getElementById('customer').value,
                    dueDays: document.getElementById('dueDays').value
                };

                const [dashboardData, totalDebtorsData] = await Promise.all([
                    makeRequest('getDashboardData', params),
                    makeRequest('getTotalDebtors')
                ]);

                currentData = dashboardData.data;
                updateTotals(dashboardData.totals, totalDebtorsData.grandTotal);
                updateTable(dashboardData.headers, dashboardData.data);
                
                showSuccess('Dashboard refreshed successfully!');
            } catch (error) {
                console.error('Error refreshing dashboard:', error);
                showError('Failed to refresh dashboard: ' + error.message);
                tableBody.innerHTML = '<tr><td colspan="9" class="error">‚ùå Failed to load data</td></tr>';
            }
        }

        function updateTotals(totals, totalDebtors) {
            document.getElementById('totalDebtors').textContent = formatCurrency(totalDebtors);
            document.getElementById('overdueTotal').textContent = formatCurrency(totals.overdue);
            document.getElementById('regularTotal').textContent = formatCurrency(totals.regular);
            document.getElementById('grandTotal').textContent = formatCurrency(totals.grand);
        }

        function updateTable(headers, data) {
            const tableBody = document.getElementById('tableBody');
            
            if (data.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="9" class="loading">üì≠ No data found matching your criteria</td></tr>';
                return;
            }

            tableBody.innerHTML = '';
            
            data.forEach((item, index) => {
                const row = document.createElement('tr');
                if (item.isOverdue) {
                    row.classList.add('overdue-row');
                }

                const checkbox = `<input type="checkbox" class="checkbox" onchange="toggleRowSelection(${index}, this.checked)">`;
                const remarksInput = `<input type="text" class="remarks-input" placeholder="Enter staff remarks..." 
                                    onchange="updateRowRemarks(${index}, this.value)" value="">`;
                
                row.innerHTML = `
                    <td>${checkbox}</td>
                    <td>${item.data[0] || ''}</td>
                    <td>${item.data[1] || ''}</td>
                    <td>${item.data[2] || ''}</td>
                    <td>${item.data[3] || ''}</td>
                    <td>${formatDate(item.data[4])}</td>
                    <td>${formatDate(item.data[5])}</td>
                    <td>${formatCurrency(item.data[6])}</td>
                    <td>${remarksInput}</td>
                `;
                
                tableBody.appendChild(row);
            });
        }

        function toggleRowSelection(index, isSelected) {
            if (isSelected) {
                selectedRows.add(index);
            } else {
                selectedRows.delete(index);
            }
        }

        function updateRowRemarks(index, remarks) {
            if (currentData[index]) {
                currentData[index].staffRemarks = remarks;
            }
        }

        async function copySelectedToFindings() {
            if (selectedRows.size === 0) {
                showError('Please select at least one row to copy');
                return;
            }

            try {
                const rowsData = Array.from(selectedRows).map(index => {
                    const item = currentData[index];
                    // Include staff remarks in the data
                    const rowWithRemarks = [...item.data, item.staffRemarks || '', '', new Date().toLocaleDateString()];
                    return rowWithRemarks;
                });
                
                await makeRequest('copyToFindings', {
                    selectedRows: JSON.stringify(rowsData)
                });

                showSuccess(`${selectedRows.size} row(s) copied to Findings sheet successfully!`);
                
                // Clear selections
                selectedRows.clear();
                document.querySelectorAll('.checkbox').forEach(cb => cb.checked = false);
                
            } catch (error) {
                console.error('Error copying to findings:', error);
                showError('Failed to copy to findings: ' + error.message);
            }
        }

        async function refreshSummary() {
            const summaryTableBody = document.getElementById('summaryTableBody');
            summaryTableBody.innerHTML = '<tr><td colspan="4" class="loading">üîÑ Loading summary...</td></tr>';

            try {
                const totalDebtorsData = await makeRequest('getTotalDebtors');
                summaryData = totalDebtorsData.customers;
                updateSummaryTable();
                
                showSuccess('Summary refreshed successfully!');
            } catch (error) {
                console.error('Error refreshing summary:', error);
                showError('Failed to refresh summary: ' + error.message);
                summaryTableBody.innerHTML = '<tr><td colspan="4" class="error">‚ùå Failed to load summary</td></tr>';
            }
        }

        function sortSummary(sortBy) {
            currentSortBy = sortBy;
            
            // Update button states
            document.querySelectorAll('.sort-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            updateSummaryTable();
        }

        function updateSummaryTable() {
            const summaryTableBody = document.getElementById('summaryTableBody');
            const summaryCount = document.getElementById('summaryCount');
            
            if (summaryData.length === 0) {
                summaryTableBody.innerHTML = '<tr><td colspan="4" class="loading">üì≠ No summary data available</td></tr>';
                summaryCount.textContent = '0 customers';
                return;
            }

            // Sort data
            let sortedData = [...summaryData];
            if (currentSortBy === 'amount') {
                sortedData.sort((a, b) => b.total - a.total);
            } else {
                sortedData.sort((a, b) => a.customer.localeCompare(b.customer));
            }

            const grandTotal = sortedData.reduce((sum, item) => sum + item.total, 0);
            
            summaryTableBody.innerHTML = '';
            
            sortedData.forEach((item, index) => {
                const percentage = grandTotal > 0 ? ((item.total / grandTotal) * 100).toFixed(2) : 0;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${item.customer}</td>
                    <td>${formatCurrency(item.total)}</td>
                    <td>${percentage}%</td>
                `;
                
                summaryTableBody.appendChild(row);
            });
            
            summaryCount.textContent = `${sortedData.length} customers`;
        }

        async function refreshFindings() {
            const findingsTableBody = document.getElementById('findingsTableBody');
            findingsTableBody.innerHTML = '<tr><td colspan="7" class="loading">üîÑ Loading findings...</td></tr>';

            try {
                console.log('Refreshing findings...');
                const findingsData = await makeRequest('getFindings');
                console.log('Received findings data:', findingsData);
                
                if (!findingsData || findingsData.length === 0) {
                    findingsTableBody.innerHTML = '<tr><td colspan="7" class="loading">üì≠ No findings available. Copy some records from the main dashboard to get started.</td></tr>';
                    document.getElementById('findingsCount').textContent = '0 findings';
                    showError('No findings found. Please copy some data from the main dashboard first.');
                    return;
                }
                
                updateFindingsTable(findingsData);
                showSuccess(`Findings refreshed successfully! Found ${findingsData.length} records.`);
                
            } catch (error) {
                console.error('Error refreshing findings:', error);
                showError('Failed to refresh findings: ' + error.message);
                findingsTableBody.innerHTML = '<tr><td colspan="7" class="error">‚ùå Failed to load findings. ' + error.message + '</td></tr>';
            }
        }

        async function debugFindings() {
            try {
                console.log('Debugging findings...');
                const debugData = await makeRequest('debugFindings');
                console.log('Debug data:', debugData);
                
                let message = 'üîç Findings Sheet Debug Info:\n';
                message += `- Sheet exists: ${debugData.exists}\n`;
                if (debugData.exists) {
                    message += `- Last row: ${debugData.lastRow}\n`;
                    message += `- Last column: ${debugData.lastColumn}\n`;
                    message += `- Has data: ${debugData.hasData}\n`;
                    if (debugData.sampleData && debugData.sampleData.length > 0) {
                        message += `- Sample data: ${JSON.stringify(debugData.sampleData[0])}\n`;
                    }
                }
                
                alert(message);
                
            } catch (error) {
                console.error('Error debugging findings:', error);
                showError('Debug failed: ' + error.message);
            }
        }

        function updateFindingsTable(data) {
            const findingsTableBody = document.getElementById('findingsTableBody');
            const findingsCount = document.getElementById('findingsCount');
            
            console.log('Updating findings table with data:', data);
            
            if (!data || data.length === 0) {
                findingsTableBody.innerHTML = '<tr><td colspan="7" class="loading">üì≠ No findings data available. Copy some records from the main dashboard first.</td></tr>';
                findingsCount.textContent = '0 findings';
                return;
            }

            // Store the findings data globally for updates
            window.findingsData = data;

            findingsTableBody.innerHTML = '';
            
            data.forEach((item, index) => {
                const row = document.createElement('tr');
                
                // Staff remarks input (editable)
                const staffRemarksInput = `<textarea class="remarks-input" placeholder="Enter staff remarks..." 
                    onchange="updateStaffRemarksData(${index}, this.value)" style="min-height: 60px;">${item.staffRemarks || ''}</textarea>`;
                
                // Management remarks input (editable)
                const managementRemarksInput = `<textarea class="remarks-input" placeholder="Enter management remarks..." 
                    onchange="updateManagementRemarksData(${index}, this.value)" style="min-height: 60px;">${item.managementRemarks || ''}</textarea>`;
                
                row.innerHTML = `
                    <td>${item.customerCode || ''}</td>
                    <td>${item.customerName || ''}</td>
                    <td>${item.docNo || ''}</td>
                    <td>${formatCurrency(item.balanceDue)}</td>
                    <td>${staffRemarksInput}</td>
                    <td>${managementRemarksInput}</td>
                    <td>${formatDate(item.dateAdded)}</td>
                `;
                
                findingsTableBody.appendChild(row);
            });
            
            findingsCount.textContent = `${data.length} findings`;
        }

        function updateStaffRemarksData(index, remarks) {
            // Store staff remarks for later update
            if (!window.staffRemarks) window.staffRemarks = {};
            window.staffRemarks[index] = remarks;
        }

        function updateManagementRemarksData(index, remarks) {
            // Store management remarks for later update
            if (!window.managementRemarks) window.managementRemarks = {};
            window.managementRemarks[index] = remarks;
        }

        async function updateAllRemarks() {
            const hasStaffRemarks = window.staffRemarks && Object.keys(window.staffRemarks).length > 0;
            const hasManagementRemarks = window.managementRemarks && Object.keys(window.managementRemarks).length > 0;
            
            if (!hasStaffRemarks && !hasManagementRemarks) {
                showError('No remarks to save');
                return;
            }

            try {
                await makeRequest('updateAllFindings', {
                    staffRemarks: JSON.stringify(window.staffRemarks || {}),
                    managementRemarks: JSON.stringify(window.managementRemarks || {})
                });

                showSuccess('All remarks saved successfully!');
                
                // Clear the pending changes
                window.staffRemarks = {};
                window.managementRemarks = {};
                
                // Refresh the findings to show updated data
                setTimeout(refreshFindings, 1000);
                
            } catch (error) {
                console.error('Error saving remarks:', error);
                showError('Failed to save remarks: ' + error.message);
            }
        }

        function formatCurrency(amount) {
            if (amount == null || amount === '') return '‚Çπ0.00';
            return '‚Çπ' + parseFloat(amount).toLocaleString('en-IN', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }

        function formatDate(date) {
            if (!date) return '';
            return new Date(date).toLocaleDateString('en-IN');
        }

        function truncateText(text, maxLength) {
            if (!text) return '';
            return text.length > maxLength ? text.substring(0, maxLength) + '...' : text;
        }

        function showError(message) {
            removeExistingMessages();
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.textContent = '‚ùå ' + message;
            document.querySelector('.container').insertBefore(errorDiv, document.querySelector('.nav-tabs'));
            setTimeout(() => errorDiv.remove(), 5000);
        }

        function showSuccess(message) {
            removeExistingMessages();
            const successDiv = document.createElement('div');
            successDiv.className = 'success';
            successDiv.textContent = '‚úÖ ' + message;
            document.querySelector('.container').insertBefore(successDiv, document.querySelector('.nav-tabs'));
            setTimeout(() => successDiv.remove(), 3000);
        }

        function removeExistingMessages() {
            document.querySelectorAll('.error, .success').forEach(el => el.remove());
        }
    </script>
</body>
</html>
